<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{.Title}}</title>
<link rel="stylesheet" href="/static/showstyles.css">
<link rel="stylesheet" href="/video-js-8.23.6/video-js.css">
<script src="/video-js-8.23.6/video.js"></script>
<!-- <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/videojs-vtt-support@2.0.1/dist/videojs-vtt-support.min.js"></script> -->
</head>
<body>
<header>
    <h1>Streamy</h1>
    <nav>
        <a href="/">Home</a>
    </nav>
</header>

<!-- Video Player -->
<div class="video-container">
    <!-- <video id="player" controls autoplay>
        <source id="video-source" src="" type="video/mp4">
        <track id="video-subtitle" src="" kind="subtitles" srclang="en" label="English" default>
        Your browser does not support the video tag.
    </video> -->


    <!-- via code -->
    <video id="my-player" class="video-js vjs-big-play-centered" 
        controls
        preload="auto"
        width="640"
        height="360"
        data-setup='{}'
        poster="{{.Poster}}"
    >
        <!-- <source id="video-source" type="video/mp4"> -->
        <!-- <track id="video-subtitle" kind="subtitles" srclang="en" label="English" default> -->
    </video>
</div>

<!-- Current playing info -->
<div class="current-info" id="current-info">

    <div id="poster-container">
        <img id="poster" src="{{.Poster}}">
    </div>

    <div id="show-info">
        <h4 id="show-title">{{.Title}}</h4>
        <h4 class="season-info" id="current-episode">Season 1 - Episode 1</h4>
        <h4 class="season-info">Genre: {{.Genre}}</h4>
        <h4 class="season-info">Rated: {{.Rated}}</h4>
        <h4 class="season-info">Release Date: {{.Released}}</h4>
        <h4 class="season-info">Release Duration: {{.Year}}</h4>
        <!-- <div id="ratings" class="row">
            
            
            
            
        </div> -->
        <h4 class="season-info">Director: {{.Director}}</h4>
        <h4 class="season-info">Actors: {{.Actors}}</h4>
        <h4 class="season-info">Plot: {{.Plot}}</h4>


        
    </div>

    
</div>

<!-- Season Tabs -->
<div id="season-tabs-container">


    <div class="tab-bar">
        {{range $i, $s := .Content}}
            <button class="tab" id="tab-{{$s.Season}}" onclick="showSeason('{{$s.Season}}')">
                Season {{$s.Season}}
            </button>
        {{end}}
    </div>
</div>

<!-- Episodes Cards -->
{{range $i, $s := .Content}}
<div class="episodes" id="season-{{$s.Season}}">
    {{ $title := $.Title }}
    {{ $season := $s.Season }}
    {{range $ep := $s.Episodes}}
        <div class="episode-card"
            onclick="playEpisode('{{$title}}', '{{$season}}', '{{$ep.FileName}}', '{{$ep.Extension}}')">
            <div class="episode-title">{{$ep.FileName}}</div>
        </div>
    {{end}}
</div>
{{end}}

<script>
let player_js; // global reference to the video source

// watch videojs player and update icon
//player_js.on('play', () => player.controlBar.playToggle.update());
//player_js.on('pause', () => player.controlBar.playToggle.update());


// const player = document.getElementById("my-player");
// const videoSource = document.getElementById("video-source");
//const videoSubtitles = document.getElementById("video-subtitle");
const seasonInfo = document.getElementById("season-info");
const curEpisode = document.getElementById("current-episode");
// const episodeInfo = document.getElementById("episode-info");

function playEpisode(title, season, fileName, extension) {
    console.log(title,season,fileName,extension);
    const videoUrl = `/media/shows/${title}/Season ${season}/${fileName}${extension}`;
    console.log(videoUrl);

    // Update the player source dynamically
    player_js.src({ src: videoUrl, type: `video/${extension.replace('.', '')}` });
    // native way to change video src
    // videoSource.src = videoUrl;
    //player_js.load();
    //player_js.play();
    //seasonInfo.textContent = `Season ${season} â€¢ ${fileName}`;

    // set episode to current one in viewing...
    curEpisode.textContent = fileName;
    
    // get subtitles into track if there are any that match episode name

    //videoSubtitles.src = `/media/shows/${title}/Season ${season}/subs/${fileName}.vtt`;
    //console.log(videoSubtitles);

    var subtitleFileName = fileName;
    const regex = /S\d+E\d+/i;
    const match = subtitleFileName.match(regex);  
    
    if (match) {
        const seasonEpisode = match[0]; // This will be "S01E12"
        console.log("Extracted:", seasonEpisode);

        // Get all current remote text tracks
        const oldTracks = player_js.remoteTextTracks();
        // loop through and remove all
        let i = oldTracks.length;
        while (i--) {
            player_js.removeRemoteTextTrack(oldTracks[i]);
        }

        // add subtitle track...
        player_js.addRemoteTextTrack({
        kind: 'subtitles',
        src: `/media/shows/${title}/Season ${season}/subs/${seasonEpisode}.vtt`,
        srclang: 'en',
        label: 'English',
        default: true
        }, true);
    } else {
        console.warn("No S##E## pattern found in filename.");
    }

    // player_js.addRemoteTextTrack({
    //     kind: 'subtitles',
    //     src: `/media/shows/${title}/Season ${season}/${fileName}.vtt`,
    //     srclang: 'en',
    //     label: 'English',
    //     default: true
    //     }, true);


}

function showSeason(num) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + num).classList.add('active');

    document.querySelectorAll('.episodes').forEach(e => e.style.display = 'none');
    document.getElementById('season-' + num).style.display = 'flex';
}

// Default open first season and first episode
window.addEventListener('DOMContentLoaded', () => {
    const firstTab = document.querySelector('.tab');
    if (firstTab) {
        firstTab.classList.add('active');
        const firstSeason = firstTab.id.split('-')[1];
        showSeason(firstSeason);

        const firstEpisode = document.querySelector(`#season-${firstSeason} .episode-card`);
        if (firstEpisode) {
            const epTitle = firstEpisode.querySelector('.episode-title').textContent;
            const url = firstEpisode.getAttribute('onclick').match(/'(.*?)'/)[1];
            //playEpisode(url, firstSeason, epTitle);

        }
    }
});

// Wait until the script loads
document.addEventListener('DOMContentLoaded', () => {
    player_js = videojs('my-player', {
        autoplay: true,
        controls: true,
        loop: false,
        fluid: true,
        controlBar: {
            // audioTrackButton,
            skipButtons: {
                forward: 10,
                backward: 10
            },
        }
    });

    var subtitleFileName = fileName

    // Add the subtitle track dynamically
    // player_js.addRemoteTextTrack({
    //     kind: 'subtitles',
    //     // path + subtitle filename
    //     src: `/media/shows/${title}/Season ${season}/${fileName}.vtt`,
    //     //src: '/path/to/your/subtitles.vtt', // The file path you mentioned you'd handle
    //     srclang: 'en',
    //     label: 'English',
    //     default: true // Set to true if you want them on by default
    // }, false);
});

</script>
</body>
</html>